(window.webpackJsonp=window.webpackJsonp||[]).push([[179],{552:function(a,t,s){"use strict";s.r(t);var n=s(10),e=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("blockquote",[s("p",[a._v("专栏原创出处："),s("a",{attrs:{href:"https://github.com/GourdErwa/review-notes/tree/master/language/java-jvm",target:"_blank",rel:"noopener noreferrer"}},[a._v("github-源笔记文件 "),s("OutboundLink")],1),a._v(" ，"),s("a",{attrs:{href:"https://github.com/GourdErwa/java-advanced/tree/master/java-jvm",target:"_blank",rel:"noopener noreferrer"}},[a._v("github-源码 "),s("OutboundLink")],1),a._v("，欢迎 Star，转载请附上原文出处链接和本声明。")])]),a._v(" "),s("p",[a._v("Java JVM-虚拟机专栏系列笔记，系统性学习可访问个人复盘笔记-技术博客 "),s("a",{attrs:{href:"https://review-notes.top/language/java-jvm/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM-虚拟机 "),s("OutboundLink")],1)]),a._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#一、前言"}},[a._v("一、前言")])]),s("li",[s("a",{attrs:{href:"#二、通过简单的代码分析"}},[a._v("二、通过简单的代码分析")])]),s("li",[s("a",{attrs:{href:"#参考"}},[a._v("参考")])]),s("li",[s("a",{attrs:{href:"#本专栏更多相关笔记"}},[a._v("本专栏更多相关笔记")])])])]),s("p"),a._v(" "),s("h2",{attrs:{id:"一、前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、前言"}},[a._v("#")]),a._v(" 一、前言")]),a._v(" "),s("p",[a._v("对于 invokedynamic 指令的实现需要方法句柄作为前提知识点。可参考 "),s("a",{attrs:{href:"https://gourderwa.blog.csdn.net/article/details/104024058",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM 动态方法调用之方法句柄 MethodHandle"),s("OutboundLink")],1),a._v("。")]),a._v(" "),s("p",[a._v("本文以 Lambda 表达式中运用 invokedynamic 的实现分析。")]),a._v(" "),s("h2",{attrs:{id:"二、通过简单的代码分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、通过简单的代码分析"}},[a._v("#")]),a._v(" 二、通过简单的代码分析")]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InvokeDynamicExample")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("lambda1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Runnable")]),a._v(" runnable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        runnable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("转为字节码后，关键字节码如下：")]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("lambda1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Code")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("\n      stack"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" locals"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" args_size"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" invokedynamic #"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 生成动态调用站点")]),a._v("\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" astore_1\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" aload_1\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" invokeinterface #"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 调用 lambda 表达式")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("12")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("LocalVariableTable")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Start")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Length")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Slot")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Name")]),a._v("   "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Signature")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("13")]),a._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("this")]),a._v("   "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("LInvokeDynamicExample")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),a._v("       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7")]),a._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" runnable   "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Ljava")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("lang"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Runnable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" lambda$lambda1$"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// Runnable lambda 表达式默认生成的方法")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Code")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("\n      stack"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" locals"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" args_size"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" iconst_1\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" istore_0\n         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("BootstrapMethods")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 引导方法")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" #"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("23")]),a._v(" invokestatic   "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 调用静态方法 LambdaMetafactory.metafactory() 返回 CallSite 对象")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Method")]),a._v(" arguments"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 静态方法关联参数")]),a._v("\n      #"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("24")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("V")]),a._v("\n      #"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("25")]),a._v(" invokestatic "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InvokeDynamicExample")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("lambda$lambda1$"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("V")]),a._v("\n      #"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("24")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("V")]),a._v("\n")])])]),s("p",[a._v("大体流程：")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("javac 编译期间将 Lambda 表达式内容编译为一个新的方法，如果表达式与外部成员变量没有关联，编译为静态方法，否则编译为非静态方法。")]),a._v(" "),s("p",[a._v("上述示例被编译为 "),s("code",[a._v("private static void lambda$lambda1$0")]),a._v(" 静态方法。")])]),a._v(" "),s("li",[s("p",[a._v("代码执行 invokedynamic 指令时，将调用常量池对应的 BootstrapMethods(引导方法) ，引导方法返回一个动态调用站点对象 CallSite，该对象绑定了要执行的方法句柄。")]),a._v(" "),s("p",[a._v("上述示例引导方法为 "),s("code",[a._v("#23 LambdaMetafactory.metafactory")]),a._v(" ，该方法返回一个动态调用站点对象 CallSite")])]),a._v(" "),s("li",[s("p",[a._v("动态调用站点对象 CallSite 上绑定了 "),s("code",[a._v("lambda$lambda1$0")]),a._v(" 方法相关的信息（参考字节码 #25）。")])]),a._v(" "),s("li",[s("p",[a._v("之后执行 "),s("code",[a._v("runnable.run();")]),a._v(" 代码时，虚拟机则直接调用已经绑定了调用点所链接的 "),s("code",[a._v("lambda$lambda1$0")]),a._v(" 方法。")])])]),a._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[a._v("#")]),a._v(" 参考")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("动态调用站点 CallSite 对象有关的更多字段类型可参考 AbstractValidatingLambdaMetafactory 类定义。")])]),a._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://docs.oracle.com/en/java/javase/13/vm/support-non-java-languages.html#GUID-5A6C7674-3FE3-48EC-A685-5F71FDBFE921",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方-Using the invokedynamic Instruction"),s("OutboundLink")],1)])]),a._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://www.zhihu.com/question/39462935",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java 8 的 Lambda 表达式为什么要基于 invokedynamic？"),s("OutboundLink")],1)])])]),a._v(" "),s("h2",{attrs:{id:"本专栏更多相关笔记"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#本专栏更多相关笔记"}},[a._v("#")]),a._v(" 本专栏更多相关笔记")]),a._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"https://gourderwa.blog.csdn.net/article/details/103979966",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM 运行时栈帧结构、字节码分析实战 "),s("OutboundLink")],1)])]),a._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://gourderwa.blog.csdn.net/article/details/103976523",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM 字节码指令，指令表收录 "),s("OutboundLink")],1)])]),a._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://gourderwa.blog.csdn.net/article/details/103990943",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM 字节码-为什么 new 指令后执行 dup 指令?"),s("OutboundLink")],1)])]),a._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://gourderwa.blog.csdn.net/article/details/103995120",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM 从方法调用的角度分析重载、重写的本质 "),s("OutboundLink")],1)])]),a._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://gourderwa.blog.csdn.net/article/details/104024058",target:"_blank",rel:"noopener noreferrer"}},[a._v("Java JVM 动态方法调用之方法句柄 MethodHandle"),s("OutboundLink")],1)])])])])}),[],!1,null,null,null);t.default=e.exports}}]);